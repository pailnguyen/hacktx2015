<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>HackTX 2015 Demo</title>
		<link rel="stylesheet" type="text/css" href="css/game.css">
		<script type="text/javascript" src="js/jquery-2.1.4.js"></script>
		<script type="text/javascript" src="js/typed.js"></script>
		<script type="text/javascript" src="js/headtrackr.js"></script>
		<script type="text/javascript">
			$(function(){
				$(".typed-element").typed({
					strings: ["HackTX 2015"],
					typeSpeed: 100, // millseconds between characters
					loop: false,
					loopCount: false,
					cursorChar: " ",
				});
			});
		</script>
	</head>
	<body>
		<div class="container">
			<header>
				<div class="title typed-element"></div>
			</header>
			<section class="content">
				<canvas id="inputCanvas" width="320" height="240" style="display: none"></canvas>
				<video id="inputVideo" autoplay loop width="320" height="240" style="display: none"></video>
				<canvas id="overlay" width="320" height="240"></canvas>
				<canvas id="debug" width="320" height="240"></canvas>
				<canvas id="gameCanvas" width="760" height="800"></canvas>
				<img src="img/xavier.png" id="xavier" style="display: none">
				<script type="text/javascript">
					var percentage = 0;
					var player = {
						rectX: percentage*760-50, 
						rectY: 700, 
						rectWidth: 100, 
						rectHeight: 100
					};
					var bullets = [];
					for (var i = 0; i < 20; i++) {
						var bullet = {
							rectX: Math.random()*760-5, 
							rectY: Math.random()*2000-2000, 
							rectWidth: 10, 
							rectHeight: 20
						}
						bullets.push(bullet);
					}
					var score = 0;

					var videoInput = document.getElementById("inputVideo");
					var canvasInput = document.getElementById("inputCanvas");
					var canvasOverlay = document.getElementById("overlay");
					var debugOverlay = document.getElementById("debug");
					var overlayContext = canvasOverlay.getContext("2d");

					var gameCanvas = document.getElementById("gameCanvas");
					var gcContext = gameCanvas.getContext("2d");

					//videoInput.style.top = "77px";
					canvasOverlay.style.position = "absolute";
					canvasOverlay.style.top = "";
					canvasOverlay.style.zIndex = "100001";
					canvasOverlay.style.display = "block";
					debugOverlay.style.position = "absolute";
					debugOverlay.style.top = "";
					debugOverlay.style.zIndex = "100002";
					debugOverlay.style.display = "block";

					var xavierImg = document.getElementById("xavier");
					

					var htracker = new headtrackr.Tracker({ui: false, debug: debugOverlay});
					htracker.init(videoInput, canvasInput);
					htracker.start();

					player.rectX = 0;

					function collides(player, bullet) {
						if (player.rectX < bullet.rectX + bullet.rectWidth && 
							player.rectX + player.rectWidth > bullet.rectX &&
							player.rectY < bullet.rectY + bullet.rectHeight) {
							return true;
						}
						return false;
					}
					var scoreDiv = document.querySelector(".typed-element");

					document.addEventListener("facetrackingEvent", function(event) {
						overlayContext.clearRect(0, 0, 320, 240);
						//console.log(event);

						if (event.detection == "CS") {
							percentage = event.x/320;
							player.rectX = percentage*760-50;
							gcContext.clearRect(0, 0, 760, 800);
							var player1pattern = gcContext.createPattern(xavierImg, "repeat");
							gcContext.fillStyle = player1pattern;
							gcContext.beginPath();
							gcContext.drawImage(xavierImg, player.rectX, player.rectY, player.rectWidth, player.rectHeight);
							gcContext.closePath();
							
							bullets.forEach(function(bullet) {
								var r = Math.floor(Math.random()*255);
								var g = Math.floor(Math.random()*255);
								var b = Math.floor(Math.random()*255);

								gcContext.beginPath();
								gcContext.fillStyle = "rgb("+r+" ,"+g+" ,"+b+")";
								gcContext.fillRect(bullet.rectX, bullet.rectY, bullet.rectWidth, bullet.rectHeight);
								gcContext.closePath();
								bullet.rectY += Math.ceil(0.3*score+3);
								if (bullet.rectY > 800) {
									bullet.rectY = Math.random()*2000-2000;
									score++;
								}
								if (collides(player, bullet)) {
									bullet.rectY = Math.random()*2000-2000;
									alert("Game over: new high score of "+score+"!");
									score = 0;
									scoreDiv.innerHTML = "Score: "+score;
								}
							});
						}
						if (score > 0) {
							scoreDiv.innerHTML = "Score: "+score;
						}
					});
				</script>
			</section>
			<footer>
				<p>This demo uses <a href="http://www.mattboldt.com/demos/typed-js/">Typed.js</a> and <a href="https://github.com/auduno/headtrackr">headtrackr.</a></p>
			</footer>
		</div>
	</body>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-68160646-1', 'auto');
		ga('send', 'pageview');

	</script>
</html>